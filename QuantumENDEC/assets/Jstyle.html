<!DOCTYPE html>
<html>
    <head>
        <title>J-style EAS box</title>
        <style>
            body {
                position: fixed;
                left: 0px;
                right: 0px;
                bottom: 6vh;
                width: fit-content;
                max-width: fit-content;
                margin-inline: auto;
                background-color: rgba(0, 0, 0, 0);
                font-family: sans-serif;
                font-size: 2.5vh;
            }

            .wrapper {
                display: none;
                grid-template-columns: 25vh 60vh;
                grid-template-rows: 4vh 10.5vh 10.5vh;

                width: 85vh;
                max-width: 85vh;

                height: 25vh;
                max-height: 25vh;

                outline-style: solid;
                outline-color: white;
                outline-width: 1%;
                border-radius: 0.1em;
                
            }

            .gridImage {
                grid-column: 1;
                grid-row: 1 / span 3;
                background-color: #002255ff;
                overflow: hidden;

                display: flex;
                flex-direction: column;
                justify-content: center;
                /*align-content: center;*/

                outline-style: solid;
                outline-color: white;
                outline-width: 1%;
                border-radius: 0.1em;
                
            }

            .gridImage img {
                width: 100%; /* Make sure the image fits the container */
                height: auto;
            }

            .gridHeadline {
                grid-column: 2;
                grid-row: 1;
                background-color: #ff2a2aff;
                color: white;
                text-align: center;

                display: flex;
                flex-direction: column;
                justify-content: center;
                /*align-content: center;*/
                font-size: 2.5vh;
            }

            .gridDescription {
                grid-column: 2;
                grid-row: 2 / span 2;
                background-color: #003380ff;
                color: white;

                padding: 1vh;
                align-content: top;
                text-align: justify;
                /*overflow: hidden; /* Ensure no overflow */
                /* height: 100%; /* Set a fixed height */
                overflow: hidden;
            }

            p#alert-text {
                display: inline;
            }
        </style>
    </head>
    <body>
        <div class="wrapper" id="EAS_BOX">
            <div class="gridHeadline" id="divHeadline"><strong id="alert-headline">EMERGENCY ALERT</strong></div>
            <div class="gridDescription"><strong id="page-counter"></strong> <p id="alert-text"></p></div>
            <div class="gridImage"><img id="alertImage" src="./tmp/alert_image.png" /></div>
        </div>

        <script>
            //function refreshImage() {
            //    const img = document.getElementById('alertImage');
            //    const timestamp = new Date().getTime(); // Create a unique timestamp
            //    img.src = './tmp/alert_image.png?' + timestamp; // Append timestamp to prevent caching
            //}
        
            function refreshImage() {
                const img = document.getElementById('alertImage');
                const timestamp = new Date().getTime(); // Unique timestamp to prevent caching
                const testSrc = './tmp/alert_image.png?' + timestamp;
        
                // Create a temporary Image object to test if the image exists
                const testImg = new Image();
                testImg.onload = function() {
                    img.src = testSrc;
                    img.style.display = 'block'; // Show the image if it loads
                };
                testImg.onerror = function() {
                    img.style.display = 'none'; // Hide the image if it fails to load
                };
                testImg.src = testSrc;
            }
        
            let textChunks = [];
            let currentChunkIndex = 0;
            let previousData = {};
            let updateTextInterval;
        
            async function fetchAlertText() {
              try {
                const response = await fetch('/alertText');
                if (!response.ok) throw new Error("Fetch failed");
        
                const data = await response.json();
        
                // Only update if data has changed
                if (JSON.stringify(data) !== JSON.stringify(previousData)) {
                  previousData = data;
        
                  const wrapper = document.getElementById('EAS_BOX');
                  const headlineElement = document.getElementById('alert-headline');
                  const alertTextElement = document.getElementById('alert-text');
                  const pageCounterElement = document.getElementById('page-counter');
                  const alertDivHeadline = document.getElementById('divHeadline');
        
                  if (data.alert_status === false) {
                    wrapper.style.display = 'none';
                    //document.body.style.backgroundColor = 'transparent';
                    return;
                  }
        
                  // Show wrapper and apply new colors
                  wrapper.style.display = 'grid';
                  //document.body.style.backgroundColor = `#${data.background_color}`;
                  alertDivHeadline.style.backgroundColor = `#${data.background_color}`;
        
                  const textColor = `#${data.text_color}`;
                  headlineElement.style.color = textColor;
                  //alertTextElement.style.color = textColor;
                  //pageCounterElement.style.color = textColor;
        
                  // Set headline
                  headlineElement.textContent = data.headline || 'Alert';
        
                  // Split and update text
                  splitTextIntoChunks(data.text || '');
                  updateText();
                  refreshImage();
                  resetUpdateTextInterval();
                }
              } catch (err) {
                console.error("Error fetching or processing alert text:", err);
              }
            }
        
            function splitTextIntoChunks(text) {
              const words = text.split(/\s+/);
              textChunks = [];
              for (let i = 0; i < words.length; i += 50) {
                textChunks.push(words.slice(i, i + 50).join(' '));
              }
              currentChunkIndex = 0;
              updatePageCounter();
            }
        
            function updateText() {
              if (textChunks.length > 0) {
                document.getElementById('alert-text').textContent = textChunks[currentChunkIndex];
                updatePageCounter();
                currentChunkIndex = (currentChunkIndex + 1) % textChunks.length;
              }
            }
        
            function updatePageCounter() {
              document.getElementById('page-counter').textContent = `(${currentChunkIndex + 1}/${textChunks.length})`;
            }
        
            function resetUpdateTextInterval() {
              if (updateTextInterval) clearInterval(updateTextInterval);
              updateTextInterval = setInterval(updateText, 30000);
            }
        
            // Start the fetch loop
            setInterval(fetchAlertText, 1000);
            fetchAlertText(); // Initial fetch
          </script>
    </body>
</html>
