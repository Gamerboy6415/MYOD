<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QD CGEN - Fullscreen</title>
  <style>
    body, html {
      height: 100%;
      margin: 2%;
      overflow: hidden;
      background-color: #00000000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
    }

    h1, p {
      margin: 1%;
      font-family: sans-serif;
    }

    h1 {
      font-size: 3.5vw;
    }

    p {
      font-size: 2.5vw;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <h1 id="alert-headline">Emergency Alert Details</h1>
  <p id="page-counter">1 / 1</p>
  <p id="alert-text"></p>

  <script>
    let textChunks = [];
    let currentChunkIndex = 0;
    let previousData = {};
    let updateTextInterval;

    async function fetchAlertText() {
      try {
        const response = await fetch('/alertText');
        if (response.ok) {
          const data = await response.json();

          // Check if the new data is different
          if (JSON.stringify(data) !== JSON.stringify(previousData)) {
            previousData = data;

            // Handle visibility
            const showAlert = data.alert_status === true;
            document.body.classList.toggle('hidden', !showAlert);
            if (!showAlert) {
                document.documentElement.style.backgroundColor = '#00000000'; // Reset to transparent
                return;
            }

            // Update headline and colors
            const headlineElement = document.getElementById('alert-headline');
            const alertTextElement = document.getElementById('alert-text');
            const pageCounterElement = document.getElementById('page-counter');

            headlineElement.textContent = data.headline;
            document.documentElement.style.backgroundColor = `#${data.background_color}`;
            //document.body.style.backgroundColor = `#${data.background_color}`;

            const textColor = `#${data.text_color}`;
            headlineElement.style.color = textColor;
            alertTextElement.style.color = textColor;
            pageCounterElement.style.color = textColor;

            // Split new text into chunks
            splitTextIntoChunks(data.text);
            updateText(); // Show the first chunk
            resetUpdateTextInterval(); // Restart the interval
          }
        } else {
          console.error('Failed to fetch alert text');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function splitTextIntoChunks(text) {
      const words = text.split(' ');
      textChunks = [];
      for (let i = 0; i < words.length; i += 120) {
        textChunks.push(words.slice(i, i + 120).join(' '));
      }
      currentChunkIndex = 0;
      updatePageCounter();
    }

    function updateText() {
      if (textChunks.length > 0) {
        document.getElementById('alert-text').textContent = textChunks[currentChunkIndex];
        updatePageCounter();
        currentChunkIndex = (currentChunkIndex + 1) % textChunks.length;
      }
    }

    function updatePageCounter() {
      const pageCounter = document.getElementById('page-counter');
      pageCounter.textContent = `${currentChunkIndex + 1} / ${textChunks.length}`;
    }

    function resetUpdateTextInterval() {
      if (updateTextInterval) clearInterval(updateTextInterval);
      updateTextInterval = setInterval(updateText, 30000);
    }

    setInterval(fetchAlertText, 1000);
    fetchAlertText();
    resetUpdateTextInterval();
  </script>
</body>
</html>
